version: 2.1

jobs:
  deploy_prod:
    machine:
      enabled: true
      # Optional but recommended if available
      # resource_class: large

    steps:
      # Checkout is not strictly required since we deploy via SSH,
      # but keeping it is harmless if you want logs/artifacts later.
      - checkout

      - add_ssh_keys:
          fingerprints:
            - $SSH_FINGERPRINT

      - run:
          name: Deploy Backend via Docker Compose
          no_output_timeout: 30m
          command: |
            ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "bash -s" << 'EOF'
              set -e

              echo "ðŸš€ Starting deployment..."

              cd /var/www/e-nutrition-be

              echo "ðŸ“¥ Fetching latest code"
              git fetch origin
              git checkout main
              git pull origin main

              echo "ðŸ³ Building Docker images"
              sudo docker-compose build --no-cache

              echo "â™»ï¸ Restarting containers"
              sudo docker-compose up -d

              echo "ðŸ§¹ Cleaning unused Docker images"
              sudo docker image prune -f

              echo "âœ… Deployment finished successfully"
            EOF

workflows:
  version: 2
  deploy:
    jobs:
      - deploy_prod:
          filters:
            branches:
              only:
                - main
