version: 2.1

jobs:
  deploy_prod:
    machine:
      enabled: true

    steps:
      - add_ssh_keys:
          fingerprints:
            - $SSH_FINGERPRINT

      - run:
          name: Deploy Backend via Docker Compose
          command: |
            ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST << 'EOF'
              set -e

              echo "ðŸš€ Starting deployment..."

              cd ~/e-nutrition-be

              echo "ðŸ“¥ Pulling latest code"
              git fetch
              git checkout main
              git pull origin main

              echo "ðŸ³ Pulling latest Docker images"
              sudo docker-compose pull

              echo "â™»ï¸ Restarting containers"
              sudo docker-compose up -d

              echo "ðŸ§¹ Cleaning unused images"
              sudo docker image prune -f

              echo "âœ… Deployment finished successfully"
            EOF

workflows:
  version: 2
  deploy:
    jobs:
      - deploy_prod:
          filters:
            branches:
              only:
                - main
