version: 2.1

jobs:
  deploy_prod:
    machine:
      enabled: true
    steps:
      # Checkout code (optional, useful for CircleCI logs)
      - checkout

      # Add your Lightsail SSH key
      - add_ssh_keys:
          fingerprints:
            - $SSH_FINGERPRINT

      # Deploy backend via SSH directly
      - run:
          name: Deploy Backend via Docker Compose
          # Prevent CircleCI from timing out on long builds
          no_output_timeout: 30m
          command: |
            ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "bash -s" << 'EOF'
              set -e

              echo "ðŸš€ Starting deployment..."

              cd /var/www/e-nutrition-be/

              echo "ðŸ“¥ Pulling latest code"
              git fetch origin
              git checkout main
              git pull origin main

              echo "ðŸ³ Building latest Docker image"
              sudo docker-compose build --no-cache

              echo "â™»ï¸ Restarting containers"
              sudo docker-compose up -d

              echo "ðŸ§¹ Cleaning unused Docker images"
              sudo docker image prune -f

              echo "âœ… Deployment finished successfully"
            EOF

workflows:
  version: 2
  deploy:
    jobs:
      - deploy_prod:
          filters:
            branches:
              only:
                - main
