version: 2.1

jobs:
  deploy_prod:
    machine:
      enabled: true

    steps:
      - add_ssh_keys:
          fingerprints:
            - $SSH_FINGERPRINT  # Your Lightsail SSH key fingerprint

      - run:
          name: Deploy Backend via Docker Compose
          command: |
            ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "bash -c '
              set -e

              echo \"ğŸš€ Starting deployment...\"

              cd /var/www/e-nutrition-be/

              echo \"ğŸ“¥ Pulling latest code\"
              git fetch
              git checkout main
              git pull origin main

              echo \"ğŸ³ Building latest Docker image\"
              sudo docker-compose build --no-cache

              echo \"â™»ï¸ Restarting containers\"
              sudo docker-compose up -d

              echo \"ğŸ§¹ Cleaning unused images\"
              sudo docker image prune -f

              echo \"âœ… Deployment finished successfully\"
            '"

workflows:
  version: 2
  deploy:
    jobs:
      - deploy_prod:
          filters:
            branches:
              only:
                - main
